# TODO; Figure out what files are needed for Chrome to update automatically
# TODO; Gain clarity on hosting extension with Chrome/Firefox privately(don't want it on the extension marketplaces, just want it available to internal team)
# TODO; CI/CD Workflow confirmed working.
# TODO; Get extensions hosted on Chrome/Firefox
# TODO; Make sure the auto-updates are working

name: Deploy Extension Updates

on:
  pull_request:
    branches:
      - main
    types: [closed]

jobs:
  deploy_if_merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout lxd-tools
        uses: actions/checkout@v4
        with:
          path: lxd-tools

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Find pr-build run ID
        id: find_run
        working-directory: lxd-tools
        run: |
          PR_SHA=${{ github.event.pull_request.head.sha }}
          RUN_ID=$(gh run list \
            --workflow "lxd-tools build" \
            --json databaseId,headSha \
            --limit 5 \
            | jq --raw-output ".[] | select(.headSha==\"$PR_SHA\") | .databaseId" \
            | head -n1)
          
          if [ -z "$RUN_ID" ]; then
            echo "Error: Could not find build run for SHA $PR_SHA"
            exit 1
          fi
          
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Download build artifact
        working-directory: lxd-tools
        run: |
          mkdir -p dist
          gh run download ${{ steps.find_run.outputs.run_id }} \
            --name lxd-tools \
            --dir dist

      - name: Verify deployment files
        working-directory: lxd-tools/dist
        run: |
          # Verify both required files exist
          if [ ! -f updates.json ]; then
            echo "Error: updates.json not found"
            exit 1
          fi
          
          XPI_FILE=$(ls lxd-extension-*.xpi 2>/dev/null | head -n1)
          if [ -z "$XPI_FILE" ]; then
            echo "Error: No .xpi file found"
            exit 1
          fi
          
          echo "Found files:"
          ls -lh updates.json "$XPI_FILE"
          
          # Export for next step
          echo "xpi_file=$XPI_FILE" >> "$GITHUB_OUTPUT"
        id: verify

      - name: Deploy to server
        working-directory: lxd-tools/dist
        run: |
          # TODO: Configure deployment mechanism
          # Files to deploy:
          #   - updates.json
          #   - ${{ steps.verify.outputs.xpi_file }}
          
          echo "Ready to deploy:"
          echo "  - updates.json"
          echo "  - ${{ steps.verify.outputs.xpi_file }}"

      # Example rsync deployment (uncomment and configure):
      # - name: Deploy via SSH
      #   working-directory: lxd-tools/dist
      #   run: |
      #     mkdir -p ~/.ssh
      #     echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
      #     chmod 600 ~/.ssh/deploy_key
      #     
      #     rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
      #       updates.json \
      #       ${{ steps.verify.outputs.xpi_file }} \
      #       ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/

    #TODO: Create a new release branch called 'feature/{version}'